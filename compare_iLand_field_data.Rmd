---
title: "Can current state of regeneration predict future stand development?"
author: "Maria Potterf"
date: "2024-09-30"
output: 
  html_document:
    toc: true           # Enables the table of contents
    toc_depth: 2        # Sets the level of headers included in the TOC
    toc_float: true     # Makes the TOC float and always visible while scrolling
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table) # Load data.table package
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)

# Set theme_classic2 as the default theme for all plots
theme_set(theme_classic2())
```

## Overview

In this overview, we focus on understanding of how how indicative the observation of the post-disturbance tree regeneration can be for future forest development. E.g., how will the structure and composition change in tehe future?

Simulation:

12 landscapes (teh most indicative in terms of climate, environment, structure and compositio)
development 0-30 years



```{r read_data, include=FALSE}

# Simulated data:
# raw simulated data 
df_sim_class <- fread('outTable/fin_sim_data.csv')

# read simulated indicators
df_sim_indicators <- fread('outTable/df_simulated_indicators.csv')

# subset of field data: 12 landscapes
df_field_ind_sub <- fread('outTable/df_field_indicators_landscapes.csv')


# compare 12 clusters: beginning (year 0) and end (year 25:30)
df_compare_end <- fread('outTable/compare_field_sim_12_lands_end.csv')

df_compare0 <- fread(      'outTable/compare_field_sim_12_lands_start.csv')



# Display the first few rows of the data
head(df_sim_class)
head(df_sim_indicators)

```


```{r functions}
create_scatter_plot <- function(data, x_var, y_var, x_label, y_label, title) {
  # Get unique clusters and assign colors
  unique_clusters <- unique(data$landscape)
  
  # Create a color palette with enough colors for each cluster
  colors <- rainbow(length(unique_clusters))  # or any other palette function
  
  # Create the scatter plot using aes with .data[[var]]
  ggplot(data, aes(x = .data[[x_var]], y = .data[[y_var]], color = factor(landscape))) +
    geom_jitter(alpha = 0.2) +  # Apply alpha to jittered points
    geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
    labs(title = title, x = x_label, y = y_label) +
    theme_classic() +
    scale_color_manual(values = colors, 
                       guide = guide_legend(override.aes = list(size = 4, alpha = 1))) #+
    #facet_wrap(.~ext_seed)
}


```

# Simulated data

 - 12 simulated landscapes (3 climatic clusters, 4+5+3 structural clusters)
- 3 climatic models = "ICHEC" "MPI"   "NCC"  
- 4 climate scenarios = "HISTO" "RCP26" "RCP45" "RCP85"
- 2 seed added/no = extrernal seeds present or not? TRUE/FALSE
- 5 repetitions

landscape 3_2 does not have no seed scenario! (no regeneration present, so otherwise there would be no trees)



```{r inspect_simulated, include=T}

unique(df_sim_class$landscape)  # 12, 3 climatic, 3-5 structural in each climate cluster
#[1] "1_1" "1_2" "1_3" "1_4" "2_1" "2_2" "2_3" "2_4" "2_5" "3_1" "3_2" "3_3"

unique(df_sim_class$species) # 24
#[1] "acps" "cabe" "potr" "saca" "quro" "acca" "frex" "ulgl" "lade" "tico" "piab" "fasy" "psme"
#[14] "soau" "pisy" "bepe" "abal" "alin" "algl" "soar" "coav" "acpl" "rops" "casa"


unique(df_sim_class$clim_model)
# [1] "ICHEC" "MPI"   "NCC"  

unique(df_sim_class$clim_scenario)
# [1] "HISTO" "RCP26" "RCP45" "RCP85"

# external seed: external seed present or not?? TRUE/FALSE
# years: 1-30
unique(df_sim_class$run_nr)  # 5 repetitions

```


## Interpret simulated clusters = landscapes

three climate-environment clusters:

-  clim_cluster_spei3  == 1 ~ "wet-warm-clay",  # Cluster 1: wet, cold, clay
-    clim_cluster_spei3  == 2 ~ "hot-dry-clay",  # Cluster 2: hot, dry, clay (more sand, less clay, more av.nitro than cluster 3)
-    clim_cluster_spei3  == 3 ~ "hot-dry-sand"    # Cluster 3: hot, dry, more sand


```{r clim_clusters_diff, include=T, echo = F, fig.width= 5, fig.height=4}

# explain climate and soil
p.tmp <- df_field_ind_sub %>% 
  ggplot(aes(x = clim_class,
             y = tmp)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))

p.prcp <- df_field_ind_sub %>% 
  ggplot(aes(x = clim_class,
             y = prcp)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))

p.spei <- df_field_ind_sub %>% 
  ggplot(aes(x = clim_class,
             y = spei3)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))

p.clay <- df_field_ind_sub %>% 
  ggplot(aes(x = clim_class,
             y = clay_extract)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5))


ggarrange(p.tmp, p.prcp, p.spei,p.clay, common.legend = T, ncol = 2, nrow = 2)


```

### structure:

- high density, high vertical layers, high richness, low rIVI,

```{r structural_clusters_diff}
# undetsrtand structural clusters
p1 <- df_field_ind_sub %>% 
  ggplot(aes(x = cluster,
             y = rIVI,
             fill = clim_class)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p2 <- df_field_ind_sub %>% 
  ggplot(aes(x = cluster,
             y = richness,
             fill = clim_class)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p3 <-df_field_ind_sub %>% 
  ggplot(aes(x = cluster,
             y = stem_density,
             fill = clim_class)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p4<-df_field_ind_sub %>% 
  ggplot(aes(x = cluster,
             y = n_vertical,
             fill = clim_class)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggarrange(p1,p2,p3,p4, common.legend = T)


```


# how does simulated data fit to field data?

check first on 12 landscapes: fit 1:1
- check at year 0
- check at the end of simulation: year 25:30


```{r compare_field_begin_simulation, echo = F}
# Create individual plots using the function
p0.1 <- create_scatter_plot(df_compare0, 
                          x_var = "rIVI_simul", 
                          y_var = "rIVI_field", 
                          x_label = "Simulated rIVI", 
                          y_label = "Field rIVI", 
                          title = "rIVI")

p0.2 <- create_scatter_plot(df_compare0, 
                          x_var = "richness_simul", 
                          y_var = "richness_field", 
                          x_label = "Simulated Richness", 
                          y_label = "Field Richness", 
                          title = "Richness")

p0.3 <- create_scatter_plot(df_compare0, 
                          x_var = "stem_density_simul", 
                          y_var = "stem_density_field", 
                          x_label = "Simulated Stem Density", 
                          y_label = "Field Stem Density", 
                          title = "Stem Density")

p0.4 <- create_scatter_plot(df_compare0, 
                          x_var = "n_vertical_simul", 
                          y_var = "n_vertical_field", 
                          x_label = "Simulated ", 
                          y_label = "Field ", 
                          title = "n Vertical")

# Arrange the plots in a 2x2 grid
ggarrange(p0.1, p0.2, p0.3, p0.4, ncol = 2, nrow = 2, common.legend = T, align = 'hv')




```

```{r compare_field_end_simulation}
# Create individual plots using the function
p1 <- create_scatter_plot(df_compare_end, 
                          x_var = "rIVI_simul", 
                          y_var = "rIVI_field", 
                          x_label = "Simulated rIVI", 
                          y_label = "Field rIVI", 
                          title = "rIVI: Simulated vs Field")

p2 <- create_scatter_plot(df_compare_end, 
                          x_var = "richness_simul", 
                          y_var = "richness_field", 
                          x_label = "Simulated Richness", 
                          y_label = "Field Richness", 
                          title = "Richness: Simulated vs Field")

p3 <- create_scatter_plot(df_compare_end, 
                          x_var = "stem_density_simul", 
                          y_var = "stem_density_field", 
                          x_label = "Simulated Stem Density", 
                          y_label = "Field Stem Density", 
                          title = "Stem Density: Simulated vs Field")

p4 <- create_scatter_plot(df_compare_end, 
                          x_var = "n_vertical_simul", 
                          y_var = "n_vertical_field", 
                          x_label = "Simulated n Vertical", 
                          y_label = "Field n Vertical", 
                          title = "n Vertical: Simulated vs Field")

# Arrange the plots in a 2x2 grid

ggarrange(p1, p2, p3, p4, ncol = 2, nrow = 2, common.legend = TRUE,
          align = 'hv')




```


## Get a composite indicator of structure

order the landscapes by individual indicators. scale all indicators and ad them together to order landscapes (from high structure and diverse composition low structural and compoistional diversity). 

Use it to simplify naming of the simulated landscapes

```{r check_landscape_composites}
par(mfrow = c(2, 2))
plot(df_field_ind_sub$composite_score, 
     df_field_ind_sub$stem_density)

plot(df_field_ind_sub$composite_score, 
     df_field_ind_sub$n_vertical)

plot(df_field_ind_sub$composite_score, 
     df_field_ind_sub$richness)

plot(df_field_ind_sub$composite_score, 
     df_field_ind_sub$rIVI)


par(mfrow = c(1, 1))
```





## Temporal development of indicators


```{r plot_richness, echo=FALSE, fig.width = 6, fig.height = 4}
###### Species richness ------------------------------------
df_sim_indicators %>% 
  ggplot() + 
  geom_line(aes(x = year,
                y = richness,
                color = landscape,
                group = unique_sim_run), alpha = 0.1) +
  theme(legend.position = 'bottom')+
   # Add median line using stat_summary
  stat_summary(aes(x = year, y = richness, group = landscape, color = landscape), 
               fun = median, 
               geom = "line", 
               linewidth = 0.8) +
  facet_wrap(. ~ext_seed)



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r plot_rIVI, echo=FALSE,fig.width = 6, fig.height = 4}
###### Species richness ------------------------------------
df_sim_indicators %>% 
  ggplot() + 
  geom_line(aes(x = year,
                y = rIVI,
                color = landscape,
                group = unique_sim_run), alpha = 0.1) +
  theme(legend.position = 'bottom')+
   # Add median line using stat_summary
  stat_summary(aes(x = year, y = rIVI, group = landscape, color = landscape), 
               fun = median, 
               geom = "line", 
               linewidth = 0.8) +
  facet_wrap(. ~ext_seed)



```
```{r plot_vertical, echo=FALSE, fig.width = 6, fig.height = 4}
###### NUmber of vertical classes ------------------------------------
df_sim_indicators %>% 
  ggplot() + 
  geom_line(aes(x = year,
                y = n_vertical,
                color = landscape,
                group = unique_sim_run), alpha = 0.1) +
  theme(legend.position = 'bottom') +
   # Add median line using stat_summary
  stat_summary(aes(x = year, y = n_vertical, group = landscape, color = landscape), 
               fun = median, 
               geom = "line", 
               linewidth = 0.8) +
  facet_wrap(. ~ext_seed)

```

```{r plot_stem_density, echo=FALSE,fig.width = 6, fig.height = 3}

df_sim_indicators %>% 
 # change in stem density
  ggplot() + 
  geom_line(aes(x = year,
                y = stem_density,
                color = landscape,
                group = unique_sim_run), alpha = 0.1) + 
   # Add median line using stat_summary
  stat_summary(aes(x = year, y = stem_density, group = landscape, color = landscape), 
               fun = median, 
               geom = "line", 
               linewidth = 0.8) +
  facet_wrap(.~ext_seed)




```